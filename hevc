#!/usr/bin/env python3
""" Encode video files to HEVC 10Bit video. """

import os
import argparse
from pymediainfo import MediaInfo as mi

# Valid extensions
EXTN = ['.avi', '.flv', '.mkv', '.mov', '.mp4', '.mpeg', '.mpg', '.webm', '.wmv']
PWD = os.getcwd() # Get Present Working Directory

def get_video_info(path, recur, flag):
    videos_list = [] # List of video file with extensions as in EXTN
    videos_list_mi = [] # List of dictionary with MediaInfo from videos_list list
    tmp_dict1 = {} # Temporary dict to hold MI Video info
    tmp_dict2 = {} # Temporary dict to hold MI General info

    # Get video files within a directory
    for root, dirs, files in os.walk(path):
        for filename in sorted(files):
            for ext in EXTN:
                if filename.lower().endswith(ext.lower()):
                    videos_list.append(os.path.join(root, filename))
        if not recur:
            break
        
    # For every video in list 'videos_list' get mediainfo in dictionary format
    for video in videos_list:
        mediainfo = mi.parse(video)
        for track in mediainfo.tracks:
            if track.track_type == 'Video':
                tmp_dict1 = {
                        "fname": video,
                        "format": track.format,
                        "width": track.width,
                        "height": track.height,
                        "duration": (float(track.duration) / 1000),
                        "duration_h": track.other_duration[3],
                        "framerate": float(track.frame_rate)
                        }
            elif track.track_type == 'General':
                tmp_dict2 = {
                        "fsize_byte": int(track.file_size),
                        "fsize_human": track.other_file_size[0]
                        }
        tmp_dict1.update(tmp_dict2) # Join tmp_dict1 + tmp_dict2
        videos_list_mi.append(tmp_dict1) # Append dictionary into the list


    # According to flags remove dictionat records from list videos_list
    if flag == 'ALL':
        return videos_list_mi
    elif flag == 'HEVC':
        videos_list_mi = [rec for rec in videos_list_mi if rec.get('format') == 'HEVC']
        return videos_list_mi
    if flag == 'OTHER':
        videos_list_mi = [rec for rec in videos_list_mi if rec.get('format') != 'HEVC']
        return videos_list_mi


def print_videos(video_list):
    count = len(video_list)
    slno = 1

    for vid in video_list:
        codec = vid['format'][:4]
        aspect = str(vid['width'])+'x'+str(vid['height'])
        dur_h = vid['duration_h']
        size_h = vid['fsize_human']
        filename = vid['fname'].replace(PWD, '.', 1)



        print(f"{slno:0>3d} {codec:4s} {aspect:9s} {dur_h:12s} {size_h:>10s} {filename}")
        slno += 1

    for i in video_list:
        print(i)
#
def parse_options():
    help_msg = 'Encode videos to HEVC 10Bit'
    parser = argparse.ArgumentParser(description=help_msg)
    group = parser.add_mutually_exclusive_group(required=True)

    group.add_argument(
            '-a', 
            dest='all_vids', 
            nargs='?', 
            action='store', 
            const=PWD, 
            metavar='PATH', 
            help='List all videos'
            )
    group.add_argument(
            '-H', 
            dest='hvc_vids', 
            nargs='?', 
            action='store', 
            const=PWD, 
            metavar='PATH', 
            help='List HEVC videos only'
            )
    group.add_argument(
            '-o', 
            dest='oth_vids', 
            nargs='?', 
            action='store', 
            const=PWD, 
            metavar='PATH', 
            help='List other videos. Exclude all HEVC videos'
            )
    group.add_argument(
            '-e', 
            dest='enc_vids', 
            nargs='?', 
            action='store', 
            const=PWD, 
            metavar='PATH', 
            help='Encode videos to HEVC 10bit'
            )
    parser.add_argument(
            '-r', 
            dest='rcr_vids', 
            action='store_true', 
            help='Set recursive option ON'
            )

    return parser.parse_args()

def main():
    args = parse_options()
    video_files = []
    if args.all_vids:
        video_files = get_video_info(args.all_vids, args.rcr_vids, 'ALL')
        print_videos(video_files)
    if args.hvc_vids:
        video_files = get_video_info(args.hvc_vids, args.rcr_vids, 'HEVC')
        print_videos(video_files)
    if args.oth_vids:
        video_files = get_video_info(args.oth_vids, args.rcr_vids, 'OTHER')
        print_videos(video_files)
    if args.enc_vids:
        video_files = get_video_info(args.enc_vids, args.rcr_vids, 'OTHER')


if __name__ == '__main__':
    main()

